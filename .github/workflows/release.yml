name: Release and Publish

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'

permissions:
  contents: write  # For creating releases
  id-token: write  # For npm OIDC provenance

jobs:
  release:
    runs-on: ubuntu-latest
    environment: npm-publish
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - name: Validate version matches tag
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "‚ùå Tag version ($TAG_VERSION) doesn't match package.json version ($PKG_VERSION)"
            exit 1
          fi
          echo "‚úÖ Version $PKG_VERSION matches tag"

      - name: Install dependencies
        run: npm ci

      - name: Run checks
        run: npm run check

      - name: Build
        run: npm run build

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true

      - name: Publish to npm
        run: npm publish

  # Update major version tag (e.g., v2) to point to this release
  # Only runs for stable releases (no prerelease suffix)
  update-major-tag:
    runs-on: ubuntu-latest
    needs: release
    # Only run for stable semver tags (v1.2.3, not v1.2.3-beta)
    if: ${{ !contains(github.ref_name, '-') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Update major version tag
        run: |
          # Extract version components from tag (e.g., v2.3.5 -> major=2)
          TAG="${GITHUB_REF#refs/tags/}"
          MAJOR=$(echo "$TAG" | sed -E 's/^v([0-9]+)\..*/\1/')
          MAJOR_TAG="v${MAJOR}"
          
          echo "üì¶ Release tag: $TAG"
          echo "üè∑Ô∏è  Major tag to update: $MAJOR_TAG"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Force update major tag to point to current commit
          git tag -f "$MAJOR_TAG" "${{ github.sha }}"
          git push origin "$MAJOR_TAG" --force
          
          echo "‚úÖ Updated $MAJOR_TAG to point to $TAG (${{ github.sha }})"
